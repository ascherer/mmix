From 91a396dab0da97ee861cc061b84c6ab862a1916b Mon Sep 17 00:00:00 2001
From: debbuild <debbuild>
Date: Sat, 7 Jan 2017 16:49:29 +0100
Subject: [PATCH 43/66] Build and apply shared library.

Collect generic modules in a shared library and link programs.
---
 Makefile | 26 ++++++++++++--------------
 1 file changed, 12 insertions(+), 14 deletions(-)

diff --git a/Makefile b/Makefile
index 42c3327..c0f5d6e 100644
--- a/Makefile
+++ b/Makefile
@@ -6,7 +6,9 @@
 #   In fact, CWEB 3.61 is recommended for making hardcopy or PDF documentation.
 
 #   If you prefer optimization to debugging, change -g to something like -O:
-CFLAGS = -g
+CFLAGS = -g -fpic
+LDFLAGS = -L.
+LDLIBS = -lmmix
 
 #   Uncomment the second line if you use pdftex to bypass .dvi files:
 PDFTEX = dvipdfm
@@ -62,17 +64,22 @@ TESTFILES = *.mms silly.run silly.out *.mmconfig *.mmix
 MISCFILES = Makefile makefile.dos README mmix.mp mmix.1
 ALL = $(WEBFILES) $(TESTFILES) $(MISCFILES)
 
-basic:  mmixal mmix
+basic:  lib mmixal mmix
 
 doc:    mmix-doc.ps mmixal.dvi mmix-sim.dvi
 	dvips -pp 0-13 mmixal.dvi -o mmixal-intro.ps
 	dvips -pp 0-8 mmix-sim.dvi -o mmix-sim-intro.ps
 
-all:    mmixal mmix mmotype mmmix
+all:    basic mmotype mmmix
 
 clean:
 	rm -f *~ *.o *.c *.h *.tex *.log *.dvi *.toc *.idx *.scn *.ps core
 
+lib: libmmix.so
+
+libmmix.so: mmix-arith.o mmix-config.o mmix-io.o mmix-mem.o mmix-pipe.o
+	$(CC) -shared $^ -o $@
+
 .SECONDEXPANSION:
 mmix-pipe.o mmix-sim.o: $$(subst .o,.c,$$@)
 	sed "s/#define ABSTIME/& `date +%s`/" -i $<
@@ -80,17 +87,8 @@ mmix-pipe.o mmix-sim.o: $$(subst .o,.c,$$@)
 
 mmix-config.o: mmix-pipe.o
 
-mmmix:  mmix-arith.o mmix-pipe.o mmix-config.o mmix-mem.o mmix-io.o mmmix.c
-	$(CC) $(CFLAGS) $^ -o $@
-
-mmixal: mmix-arith.o mmixal.c
-	$(CC) $(CFLAGS) $^ -o $@
-
-mmix:   mmix-arith.o mmix-io.o mmix-sim.o
-	$(CC) $(CFLAGS) $^ -o $@
-
-mmotype: mmotype.c
-	$(CC) $(CFLAGS) $^ -o $@
+mmix: mmix-sim.o lib
+	$(CC) $(LDFLAGS) $< -o $@ $(LDLIBS)
 
 tarfile: $(ALL)
 	tar cvf /tmp/mmix.tar $(ALL)
-- 
2.15.1

